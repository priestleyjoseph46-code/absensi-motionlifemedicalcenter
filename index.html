<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABSENSI MOTIONLIFE MEDICAL CENTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fingerprint-scanner {
            background: radial-gradient(circle, #3b82f6 0%, #1e40af 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        .scan-animation {
            animation: scan 3s ease-in-out;
        }
        
        @keyframes scan {
            0% { height: 0%; }
            50% { height: 100%; }
            100% { height: 0%; }
        }
        
        .fingerprint-pattern {
            background-image: 
                radial-gradient(circle at 30% 30%, transparent 20%, rgba(255,255,255,0.1) 21%, rgba(255,255,255,0.1) 25%, transparent 26%),
                radial-gradient(circle at 70% 70%, transparent 20%, rgba(255,255,255,0.1) 21%, rgba(255,255,255,0.1) 25%, transparent 26%);
        }
        
        .shift-card {
            transition: all 0.3s ease;
        }
        
        .shift-card:hover {
            transform: translateY(-2px);
        }
        
        .shift-active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
        
        .shift-completed {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }
        
        .shift-pending {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .status-indicator {
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen">
    <!-- Login/Register Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H11V21H5V3H13V9H21Z"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">ABSENSI MOTIONLIFE MEDICAL CENTER</h1>
                <p class="text-blue-200">Kelola kehadiran 5 shift per hari</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form id="loginFormElement" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-blue-200 mb-2">Username</label>
                        <input type="text" id="loginUsername" required 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Masukkan username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-200 mb-2">Password</label>
                        <input type="password" id="loginPassword" required 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Masukkan password">
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Masuk
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-blue-200">Belum punya akun?</p>
                    <button id="showRegister" class="text-blue-400 hover:text-blue-300 font-semibold">
                        Daftar di sini
                    </button>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <form id="registerFormElement" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-blue-200 mb-2">Nama Lengkap</label>
                        <input type="text" id="registerName" required 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Masukkan nama lengkap">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-200 mb-2">Username</label>
                        <input type="text" id="registerUsername" required 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Pilih username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-200 mb-2">Password</label>
                        <input type="password" id="registerPassword" required 
                               class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Buat password">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-blue-200 mb-2">Posisi</label>
                        <select id="registerPosition" required 
                                class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                style="background-color: rgba(255,255,255,0.15); color: white;">
                            <option value="" style="background-color: #1e293b; color: white;">Pilih posisi</option>
                            <option value="Executive" style="background-color: #1e293b; color: white;">Executive</option>
                            <option value="Wakil Direktur" style="background-color: #1e293b; color: white;">Wakil Direktur</option>
                            <option value="Manager" style="background-color: #1e293b; color: white;">Manager</option>
                            <option value="Dokter Spesialis" style="background-color: #1e293b; color: white;">Dokter Spesialis</option>
                            <option value="Dokter" style="background-color: #1e293b; color: white;">Dokter</option>
                            <option value="Asisten Dokter" style="background-color: #1e293b; color: white;">Asisten Dokter</option>
                            <option value="Perawat" style="background-color: #1e293b; color: white;">Perawat</option>
                            <option value="Training" style="background-color: #1e293b; color: white;">Training</option>
                        </select>
                    </div>
                    
                    <button type="submit" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Daftar
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-blue-200">Sudah punya akun?</p>
                    <button id="showLogin" class="text-blue-400 hover:text-blue-300 font-semibold">
                        Masuk di sini
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-lg border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.11 3.89 23 5 23H11V21H5V3H13V9H21Z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">MotionLife Medical Center</h1>
                            <p class="text-blue-200 text-sm">Sistem Absensi</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-white font-semibold" id="userNameDisplay"></p>
                            <p class="text-blue-200 text-sm" id="userPositionDisplay"></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div id="syncIndicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse" title="Tersinkron dengan perangkat lain"></div>
                            <span id="syncStatus" class="text-xs text-green-400">Sync</span>
                        </div>
                        <button id="changePasswordBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            üîë Ganti Password
                        </button>
                        <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Navigation -->
        <nav id="adminNav" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
                <div class="flex flex-wrap gap-2">
                    <button id="navDashboard" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        üìä Dashboard
                    </button>
                    <button id="navUsers" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        üë• Kelola User
                    </button>
                    <button id="navReports" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        üìã Laporan Absensi
                    </button>
                    <button id="navMyAttendance" class="nav-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        ‚è∞ Absensi Saya
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Admin Dashboard Stats -->
            <div id="adminStats" class="hidden grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zM4 18v-4h3v4h2v-7.5c0-.83.67-1.5 1.5-1.5S12 9.67 12 10.5V11h2v-.5c0-.83.67-1.5 1.5-1.5S17 9.67 17 10.5V18h2v2H4v-2z"/>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-blue-200 text-sm">Total User</p>
                            <p class="text-2xl font-bold text-white" id="totalUsers">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-blue-200 text-sm">Hadir Hari Ini</p>
                            <p class="text-2xl font-bold text-white" id="todayAttendance">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-blue-200 text-sm">Shift Aktif</p>
                            <p class="text-2xl font-bold text-white" id="activeShifts">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-blue-200 text-sm">Total Absensi</p>
                            <p class="text-2xl font-bold text-white" id="totalAttendance">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Section -->
            <div id="userManagement" class="hidden bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Kelola User</h2>
                    <div class="text-sm text-blue-200">
                        Total: <span id="userCount" class="font-bold">0</span> user terdaftar
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="pb-3 text-blue-200 font-semibold">Nama</th>
                                <th class="pb-3 text-blue-200 font-semibold">Username</th>
                                <th class="pb-3 text-blue-200 font-semibold">Posisi</th>
                                <th class="pb-3 text-blue-200 font-semibold">Tgl Daftar</th>
                                <th class="pb-3 text-blue-200 font-semibold">Status</th>
                                <th class="pb-3 text-blue-200 font-semibold">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="userList">
                            <!-- Users will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="hidden bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Laporan Absensi</h2>
                    <div class="flex space-x-2">
                        <select id="filterPeriod" class="bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white text-sm" style="background-color: rgba(255,255,255,0.15); color: white;">
                            <option value="today" style="background-color: #1e293b; color: white;">Hari Ini</option>
                            <option value="week" selected style="background-color: #1e293b; color: white;">Minggu Ini</option>
                            <option value="month" style="background-color: #1e293b; color: white;">Bulan Ini</option>
                            <option value="all" style="background-color: #1e293b; color: white;">Semua Data</option>
                        </select>
                        <select id="filterUser" class="bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white text-sm" style="background-color: rgba(255,255,255,0.15); color: white;">
                            <option value="" style="background-color: #1e293b; color: white;">Semua User</option>
                        </select>
                        <select id="filterShift" class="bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white text-sm" style="background-color: rgba(255,255,255,0.15); color: white;">
                            <option value="" style="background-color: #1e293b; color: white;">Semua Shift</option>
                            <option value="1" style="background-color: #1e293b; color: white;">Shift 1</option>
                            <option value="2" style="background-color: #1e293b; color: white;">Shift 2</option>
                            <option value="3" style="background-color: #1e293b; color: white;">Shift 3</option>
                            <option value="4" style="background-color: #1e293b; color: white;">Shift 4</option>
                            <option value="5" style="background-color: #1e293b; color: white;">Shift 5</option>
                        </select>
                        <button id="showWeeklySummary" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                            üìà Rekap Mingguan
                        </button>
                        <button id="exportExcel" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                            üìä Export Excel
                        </button>
                        <button id="exportPDF" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                            üìÑ Export PDF
                        </button>
                    </div>
                </div>
                
                <!-- Weekly Summary Section -->
                <div id="weeklySummarySection" class="hidden mb-8 p-6 bg-white/5 rounded-xl border border-white/10">
                    <h3 class="text-xl font-bold text-white mb-6">üìà Rekap Jam Kerja Mingguan - Semua User</h3>
                    
                    <!-- Week Period Display -->
                    <div class="mb-6 p-4 bg-blue-500/20 rounded-lg">
                        <h4 class="text-blue-200 text-sm font-semibold mb-2">üìÖ Periode Minggu Ini</h4>
                        <p class="text-white font-bold" id="weekPeriod">-</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Summary Cards -->
                        <div class="space-y-4">
                            <div class="bg-blue-500/20 rounded-lg p-4">
                                <h4 class="text-blue-200 text-sm font-semibold mb-2">Total Jam Kerja Minggu Ini</h4>
                                <p class="text-3xl font-bold text-white" id="totalWeeklyHours">0 jam</p>
                                <p class="text-blue-200 text-xs mt-1" id="totalSessions">0 sesi kerja</p>
                            </div>
                            <div class="bg-green-500/20 rounded-lg p-4">
                                <h4 class="text-green-200 text-sm font-semibold mb-2">Rata-rata per User</h4>
                                <p class="text-2xl font-bold text-white" id="averageWeeklyHours">0 jam</p>
                                <p class="text-green-200 text-xs mt-1" id="activeUsersCount">0 user aktif</p>
                            </div>
                            <div class="bg-yellow-500/20 rounded-lg p-4">
                                <h4 class="text-yellow-200 text-sm font-semibold mb-2">User Paling Aktif</h4>
                                <p class="text-lg font-bold text-white" id="mostActiveUser">-</p>
                                <p class="text-yellow-200 text-xs mt-1" id="mostActiveUserDetails">-</p>
                            </div>
                            <div class="bg-purple-500/20 rounded-lg p-4">
                                <h4 class="text-purple-200 text-sm font-semibold mb-2">Shift Terpopuler</h4>
                                <p class="text-lg font-bold text-white" id="popularShift">-</p>
                                <p class="text-purple-200 text-xs mt-1" id="popularShiftHours">0 jam total</p>
                            </div>
                        </div>
                        
                        <!-- Weekly Chart -->
                        <div class="bg-white/5 rounded-lg p-4">
                            <h4 class="text-blue-200 text-sm font-semibold mb-4">üìä Distribusi Jam Kerja per Hari</h4>
                            <div id="weeklyChart" class="space-y-2">
                                <!-- Chart will be populated by JavaScript -->
                            </div>
                            <div class="mt-4 text-center">
                                <p class="text-xs text-blue-300">Total minggu ini: <span id="chartTotal" class="font-bold">0 jam</span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Row -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white/5 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-white" id="totalUsers">0</p>
                            <p class="text-xs text-blue-200">Total User</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-green-400" id="workingUsers">0</p>
                            <p class="text-xs text-blue-200">User Bekerja</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-yellow-400" id="totalShifts">0</p>
                            <p class="text-xs text-blue-200">Total Shift</p>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 text-center">
                            <p class="text-2xl font-bold text-purple-400" id="avgDailyHours">0</p>
                            <p class="text-xs text-blue-200">Rata-rata/Hari</p>
                        </div>
                    </div>
                    
                    <!-- Detailed Weekly Table -->
                    <div class="mt-6">
                        <h4 class="text-white font-semibold mb-4">Detail Jam Kerja per User</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b border-white/20">
                                        <th class="pb-3 text-blue-200 font-semibold">User</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Posisi</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Sen</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Sel</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Rab</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Kam</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Jum</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Sab</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Min</th>
                                        <th class="pb-3 text-blue-200 font-semibold">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyDetailTable">
                                    <!-- Weekly details will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="pb-3 text-blue-200 font-semibold">User</th>
                                <th class="pb-3 text-blue-200 font-semibold">Posisi</th>
                                <th class="pb-3 text-blue-200 font-semibold">Tanggal</th>
                                <th class="pb-3 text-blue-200 font-semibold">Shift</th>
                                <th class="pb-3 text-blue-200 font-semibold">Masuk</th>
                                <th class="pb-3 text-blue-200 font-semibold">Keluar</th>
                                <th class="pb-3 text-blue-200 font-semibold">Durasi</th>
                                <th class="pb-3 text-blue-200 font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="reportsList">
                            <!-- Reports will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Current Time and Date -->
            <div id="timeDisplay" class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20">
                <div class="text-center">
                    <div id="currentTime" class="text-4xl font-bold text-white mb-2"></div>
                    <div id="currentDate" class="text-xl text-blue-200 mb-2"></div>
                    <div class="flex items-center justify-center space-x-4 text-sm text-blue-300">
                        <div class="flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17 2v2h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V2h2v2h6V2h2zM4 8v10h16V8H4z"/>
                            </svg>
                            <span id="deviceInfo">Sinkron lintas jaringan</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span>Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div id="quickActions" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Fingerprint Scanner -->
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20">
                    <h2 class="text-xl font-bold text-white mb-6 text-center">Scan Sidik Jari</h2>
                    <div class="flex justify-center mb-6">
                        <div class="fingerprint-scanner fingerprint-pattern w-32 h-32 rounded-full flex items-center justify-center relative overflow-hidden cursor-pointer" id="fingerprintScanner">
                            <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12zM14.91 22c-.04 0-.09-.01-.13-.02-1.59-.44-2.63-1.03-3.72-2.1-1.4-1.39-2.17-3.24-2.17-5.22 0-1.62 1.38-2.94 3.08-2.94 1.7 0 3.08 1.32 3.08 2.94 0 1.07.93 1.94 2.08 1.94s2.08-.87 2.08-1.94c0-3.77-3.25-6.83-7.25-6.83-2.84 0-5.44 1.58-6.61 4.03-.39.81-.59 1.76-.59 2.8 0 .78.07 2.01.67 3.61.1.26-.03.55-.29.64-.26.1-.55-.04-.64-.29-.49-1.31-.73-2.61-.73-3.96 0-1.2.23-2.29.68-3.24 1.33-2.79 4.28-4.6 7.51-4.6 4.55 0 8.25 3.51 8.25 7.83 0 1.62-1.38 2.94-3.08 2.94s-3.08-1.32-3.08-2.94c0-1.07-.93-1.94-2.08-1.94s-2.08.87-2.08 1.94c0 1.71.66 3.31 1.87 4.51.95.94 1.86 1.46 3.27 1.85.27.07.42.35.35.61-.05.23-.26.38-.47.38z"/>
                            </svg>
                            <div id="scanLine" class="absolute top-0 left-0 w-full bg-blue-300 opacity-50 hidden"></div>
                        </div>
                    </div>
                    <p class="text-center text-blue-200 text-sm mb-4">Klik untuk scan absensi</p>
                    <div class="text-center">
                        <button id="manualSyncBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200">
                            üîÑ Sinkron Lintas Jaringan
                        </button>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20">
                    <h2 class="text-xl font-bold text-white mb-6 text-center">Status Saat Ini</h2>
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" id="statusIndicator">
                            <div class="w-4 h-4 rounded-full status-indicator" id="statusDot"></div>
                        </div>
                        <p class="text-2xl font-bold text-white mb-2" id="currentStatus">Belum Absen</p>
                        <p class="text-blue-200" id="statusTime">-</p>
                    </div>
                </div>
            </div>

            <!-- Shift Schedule -->
            <div id="shiftSchedule" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 mb-8">
                <h2 class="text-2xl font-bold text-white mb-6">Jadwal Shift Hari Ini</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="shiftScheduleGrid">
                    <!-- Shifts will be populated by JavaScript -->
                </div>
            </div>

            <!-- Personal Duty Hours Summary -->
            <div id="personalDutySummary" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">üìä Ringkasan Jam Kerja Saya</h2>
                    <div class="flex space-x-2">
                        <select id="personalPeriodFilter" class="bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white text-sm" style="background-color: rgba(255,255,255,0.15); color: white;">
                            <option value="week" selected style="background-color: #1e293b; color: white;">Minggu Ini</option>
                            <option value="month" style="background-color: #1e293b; color: white;">Bulan Ini</option>
                            <option value="all" style="background-color: #1e293b; color: white;">Semua Waktu</option>
                        </select>
                        <button id="exportPersonalData" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm">
                            üìä Export Data Saya
                        </button>
                    </div>
                </div>
                
                <!-- Personal Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-500/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-white" id="personalTotalHours">0j</div>
                        <div class="text-blue-200 text-sm">Total Jam Kerja</div>
                        <div class="text-blue-300 text-xs mt-1" id="personalPeriodText">-</div>
                    </div>
                    <div class="bg-green-500/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-white" id="personalTotalSessions">0</div>
                        <div class="text-green-200 text-sm">Total Sesi</div>
                        <div class="text-green-300 text-xs mt-1" id="personalCompletedSessions">0 selesai</div>
                    </div>
                    <div class="bg-yellow-500/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-white" id="personalAvgHours">0j</div>
                        <div class="text-yellow-200 text-sm">Rata-rata/Hari</div>
                        <div class="text-yellow-300 text-xs mt-1" id="personalEfficiency">0j/sesi</div>
                    </div>
                    <div class="bg-purple-500/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-white" id="personalFavoriteShift">-</div>
                        <div class="text-purple-200 text-sm">Shift Favorit</div>
                        <div class="text-purple-300 text-xs mt-1" id="personalFavoriteShiftHours">0j</div>
                    </div>
                </div>
                
                <!-- Personal Weekly Chart -->
                <div class="bg-white/5 rounded-lg p-4 mb-6">
                    <h4 class="text-blue-200 text-sm font-semibold mb-4">üìà Distribusi Jam Kerja (7 Hari Terakhir)</h4>
                    <div id="personalWeeklyChart" class="space-y-2">
                        <!-- Chart will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Shift Breakdown -->
                <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-blue-200 text-sm font-semibold mb-4">üîÑ Breakdown per Shift</h4>
                    <div id="personalShiftBreakdown" class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <!-- Shift breakdown will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Attendance History -->
            <div id="attendanceHistorySection" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 border border-white/20">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Riwayat Absensi</h2>
                    <div class="text-sm text-blue-200">
                        Menampilkan <span id="historyCount">0</span> record terakhir
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="pb-3 text-blue-200 font-semibold">Tanggal</th>
                                <th class="pb-3 text-blue-200 font-semibold">Shift</th>
                                <th class="pb-3 text-blue-200 font-semibold">Masuk</th>
                                <th class="pb-3 text-blue-200 font-semibold">Keluar</th>
                                <th class="pb-3 text-blue-200 font-semibold">Durasi</th>
                                <th class="pb-3 text-blue-200 font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceHistory">
                            <!-- History will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Ganti Password</h2>
            <form id="changePasswordForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Password Lama</label>
                    <input type="password" id="oldPassword" required 
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Masukkan password lama">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Password Baru</label>
                    <input type="password" id="newPassword" required 
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Masukkan password baru">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Konfirmasi Password Baru</label>
                    <input type="password" id="confirmPassword" required 
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Konfirmasi password baru">
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" id="cancelPasswordChange" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Ganti Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Position Modal -->
    <div id="editPositionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Edit Posisi User</h2>
            <form id="editPositionForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Nama User</label>
                    <input type="text" id="editUserName" readonly 
                           class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Posisi Baru</label>
                    <select id="editUserPosition" required 
                            class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            style="background-color: rgba(255,255,255,0.15); color: white;">
                        <option value="Executive" style="background-color: #1e293b; color: white;">Executive</option>
                        <option value="Wakil Direktur" style="background-color: #1e293b; color: white;">Wakil Direktur</option>
                        <option value="Manager" style="background-color: #1e293b; color: white;">Manager</option>
                        <option value="Dokter Spesialis" style="background-color: #1e293b; color: white;">Dokter Spesialis</option>
                        <option value="Dokter" style="background-color: #1e293b; color: white;">Dokter</option>
                        <option value="Asisten Dokter" style="background-color: #1e293b; color: white;">Asisten Dokter</option>
                        <option value="Perawat" style="background-color: #1e293b; color: white;">Perawat</option>
                        <option value="Training" style="background-color: #1e293b; color: white;">Training</option>
                        <option value="Admin" style="background-color: #1e293b; color: white;">Admin</option>
                    </select>
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" id="cancelPositionEdit" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Update Posisi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Reset Password Modal -->
    <div id="adminResetPasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md border border-white/20">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Reset Password User</h2>
            <form id="adminResetPasswordForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Nama User</label>
                    <input type="text" id="resetUserName" readonly 
                           class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-lg text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Password Baru</label>
                    <input type="password" id="adminNewPassword" required 
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Masukkan password baru">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-blue-200 mb-2">Konfirmasi Password Baru</label>
                    <input type="password" id="adminConfirmPassword" required 
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Konfirmasi password baru">
                </div>
                
                <div class="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-3">
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-yellow-200 text-sm">Password akan direset dan user harus login ulang</span>
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button type="button" id="cancelAdminPasswordReset" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let users = [];
        let attendanceData = [];
        let currentShift = null;
        let deviceId = localStorage.getItem('motionlife_device_id') || generateDeviceId();
        let syncKey = 'motionlife_sync_' + Date.now();
        let lastSyncHash = '';
        let syncRetryCount = 0;
        let maxSyncRetries = 3;
        
        // Generate unique device ID
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('motionlife_device_id', id);
            return id;
        }
        
        // Generate hash for data integrity checking
        function generateDataHash(data) {
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash.toString();
        }
        
        // Cross-network sync using cloud storage simulation
        function syncToCloud() {
            try {
                const syncData = {
                    users: users,
                    attendance: attendanceData,
                    timestamp: Date.now(),
                    deviceId: deviceId,
                    version: 2,
                    hash: generateDataHash({ users, attendance: attendanceData })
                };
                
                // Store in multiple cloud-like keys for redundancy
                const cloudKeys = [
                    'motionlife_cloud_primary',
                    'motionlife_cloud_backup1', 
                    'motionlife_cloud_backup2'
                ];
                
                cloudKeys.forEach(key => {
                    localStorage.setItem(key, JSON.stringify(syncData));
                });
                
                // Store network-independent sync marker
                localStorage.setItem('motionlife_network_sync', JSON.stringify({
                    lastSync: Date.now(),
                    deviceId: deviceId,
                    dataHash: syncData.hash,
                    networkId: getNetworkFingerprint()
                }));
                
                lastSyncHash = syncData.hash;
                console.log('Cloud sync successful:', { hash: syncData.hash, devices: deviceId });
                return true;
            } catch (error) {
                console.error('Cloud sync failed:', error);
                return false;
            }
        }
        
        // Get network fingerprint for cross-network detection
        function getNetworkFingerprint() {
            try {
                // Create a unique fingerprint based on available browser info
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Network fingerprint', 2, 2);
                
                const fingerprint = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    canvas.toDataURL()
                ].join('|');
                
                // Generate simple hash
                let hash = 0;
                for (let i = 0; i < fingerprint.length; i++) {
                    hash = ((hash << 5) - hash) + fingerprint.charCodeAt(i);
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            } catch (error) {
                return 'unknown_' + Date.now();
            }
        }
        
        // Load from cloud with network detection
        function loadFromCloud() {
            try {
                const cloudKeys = [
                    'motionlife_cloud_primary',
                    'motionlife_cloud_backup1', 
                    'motionlife_cloud_backup2'
                ];
                
                let latestData = null;
                let latestTimestamp = 0;
                
                // Find the most recent data across all cloud keys
                cloudKeys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key) || '{}');
                        if (data.timestamp && data.timestamp > latestTimestamp) {
                            latestTimestamp = data.timestamp;
                            latestData = data;
                        }
                    } catch (e) {
                        console.warn(`Failed to parse ${key}:`, e);
                    }
                });
                
                if (latestData && latestData.users && Array.isArray(latestData.users)) {
                    const newHash = generateDataHash({ users: latestData.users, attendance: latestData.attendance || [] });
                    
                    // Only update if data has actually changed
                    if (newHash !== lastSyncHash) {
                        users = latestData.users;
                        attendanceData = latestData.attendance || [];
                        lastSyncHash = newHash;
                        
                        console.log('Cloud data loaded:', { 
                            users: users.length, 
                            attendance: attendanceData.length,
                            hash: newHash,
                            fromDevice: latestData.deviceId 
                        });
                        
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Failed to load from cloud:', error);
                return false;
            }
        }
        
        // Enhanced sync with retry mechanism
        function performEnhancedSync() {
            updateSyncStatus('syncing');
            
            try {
                // First, try to load any newer data from cloud
                const hasNewData = loadFromCloud();
                
                // Then sync our current data to cloud
                const syncSuccess = syncToCloud();
                
                if (syncSuccess) {
                    // Also maintain local sync for same-network devices
                    syncData();
                    syncRetryCount = 0;
                    updateSyncStatus('success');
                    return true;
                } else {
                    throw new Error('Cloud sync failed');
                }
            } catch (error) {
                console.error('Enhanced sync error:', error);
                syncRetryCount++;
                
                if (syncRetryCount < maxSyncRetries) {
                    console.log(`Retrying sync... (${syncRetryCount}/${maxSyncRetries})`);
                    setTimeout(performEnhancedSync, 2000 * syncRetryCount); // Exponential backoff
                } else {
                    updateSyncStatus('error');
                    syncRetryCount = 0;
                }
                return false;
            }
        }
        
        // Update sync status indicator
        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            if (!indicator || !statusText) return;
            
            switch(status) {
                case 'success':
                    indicator.className = 'w-2 h-2 bg-green-400 rounded-full animate-pulse';
                    statusText.className = 'text-xs text-green-400';
                    statusText.textContent = 'Sync';
                    indicator.title = 'Tersinkron dengan perangkat lain';
                    break;
                case 'syncing':
                    indicator.className = 'w-2 h-2 bg-blue-400 rounded-full animate-spin';
                    statusText.className = 'text-xs text-blue-400';
                    statusText.textContent = 'Syncing...';
                    indicator.title = 'Sedang menyinkronkan data';
                    break;
                case 'error':
                    indicator.className = 'w-2 h-2 bg-red-400 rounded-full animate-pulse';
                    statusText.className = 'text-xs text-red-400';
                    statusText.textContent = 'Error';
                    indicator.title = 'Gagal sinkronisasi';
                    setTimeout(() => updateSyncStatus('success'), 3000);
                    break;
                case 'offline':
                    indicator.className = 'w-2 h-2 bg-gray-400 rounded-full';
                    statusText.className = 'text-xs text-gray-400';
                    statusText.textContent = 'Offline';
                    indicator.title = 'Tidak tersambung';
                    break;
            }
        }
        
        // Sync data across devices using localStorage events (local network)
        function syncData() {
            const syncData = {
                users: users,
                attendance: attendanceData,
                timestamp: Date.now(),
                deviceId: deviceId,
                version: 1
            };
            
            try {
                // Store in multiple keys for better sync reliability
                localStorage.setItem('motionlife_sync_data', JSON.stringify(syncData));
                localStorage.setItem('motionlife_users', JSON.stringify(users));
                localStorage.setItem('motionlife_attendance', JSON.stringify(attendanceData));
                localStorage.setItem('motionlife_last_update', Date.now().toString());
                
                // Trigger sync event for other tabs/windows
                localStorage.setItem('motionlife_sync_trigger', Date.now().toString());
                
                // Force immediate sync check
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'motionlife_sync_trigger',
                    newValue: Date.now().toString()
                }));
                
                console.log('Local sync successful:', { users: users.length, attendance: attendanceData.length });
                
                // Also perform enhanced cross-network sync
                performEnhancedSync();
                
            } catch (error) {
                console.error('Local sync error:', error);
                updateSyncStatus('error');
                // Fallback sync method
                try {
                    localStorage.setItem('motionlife_users_backup', JSON.stringify(users));
                    localStorage.setItem('motionlife_attendance_backup', JSON.stringify(attendanceData));
                    // Still try enhanced sync as fallback
                    performEnhancedSync();
                } catch (backupError) {
                    console.error('Backup sync failed:', backupError);
                }
            }
        }
        
        // Load synced data with cross-network support
        function loadSyncedData() {
            try {
                // First, try to load from cloud (cross-network)
                const hasCloudData = loadFromCloud();
                
                if (!hasCloudData) {
                    // Fallback to local sync data
                    const syncData = JSON.parse(localStorage.getItem('motionlife_sync_data') || '{}');
                    const localUsers = JSON.parse(localStorage.getItem('motionlife_users') || '[]');
                    const localAttendance = JSON.parse(localStorage.getItem('motionlife_attendance') || '[]');
                    const backupUsers = JSON.parse(localStorage.getItem('motionlife_users_backup') || '[]');
                    const backupAttendance = JSON.parse(localStorage.getItem('motionlife_attendance_backup') || '[]');
                    
                    // Use the most recent and complete data
                    if (syncData.timestamp && syncData.users && Array.isArray(syncData.users)) {
                        users = syncData.users;
                        attendanceData = syncData.attendance || [];
                        console.log('Loaded from local sync data:', { users: users.length, attendance: attendanceData.length });
                    } else if (localUsers.length > 0) {
                        users = localUsers;
                        attendanceData = localAttendance;
                        console.log('Loaded from local data:', { users: users.length, attendance: attendanceData.length });
                    } else if (backupUsers.length > 0) {
                        users = backupUsers;
                        attendanceData = backupAttendance;
                        console.log('Loaded from backup data:', { users: users.length, attendance: attendanceData.length });
                    } else {
                        users = [];
                        attendanceData = [];
                        console.log('No existing data found, starting fresh');
                    }
                }
                
                // Ensure data integrity
                if (!Array.isArray(users)) users = [];
                if (!Array.isArray(attendanceData)) attendanceData = [];
                
                // Update hash for future comparisons
                lastSyncHash = generateDataHash({ users, attendance: attendanceData });
                
                // Force sync after loading to ensure consistency across networks
                if (users.length > 0 || attendanceData.length > 0) {
                    setTimeout(() => {
                        updateSyncStatus('syncing');
                        performEnhancedSync();
                    }, 100);
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                // Last resort fallback
                try {
                    users = JSON.parse(localStorage.getItem('motionlife_users') || '[]');
                    attendanceData = JSON.parse(localStorage.getItem('motionlife_attendance') || '[]');
                    if (!Array.isArray(users)) users = [];
                    if (!Array.isArray(attendanceData)) attendanceData = [];
                    lastSyncHash = generateDataHash({ users, attendance: attendanceData });
                } catch (fallbackError) {
                    console.error('Fallback loading failed:', fallbackError);
                    users = [];
                    attendanceData = [];
                    lastSyncHash = '';
                }
            }
        }
        
        // Listen for sync events from other tabs/devices (including cross-network)
        window.addEventListener('storage', function(e) {
            if (e.key === 'motionlife_sync_trigger' || 
                e.key === 'motionlife_users' || 
                e.key === 'motionlife_attendance' ||
                e.key === 'motionlife_cloud_primary' ||
                e.key === 'motionlife_cloud_backup1' ||
                e.key === 'motionlife_cloud_backup2' ||
                e.key === 'motionlife_network_sync') {
                
                console.log('Storage event detected:', e.key);
                
                // Check if this is a cross-network sync event
                if (e.key.includes('cloud') || e.key === 'motionlife_network_sync') {
                    console.log('Cross-network sync detected, loading cloud data...');
                    const hasNewData = loadFromCloud();
                    if (hasNewData) {
                        console.log('New cross-network data loaded');
                    }
                } else {
                    loadSyncedData();
                }
                
                if (currentUser) {
                    renderShiftSchedule();
                    renderAttendanceHistory();
                    updateCurrentStatus();
                    updatePersonalSummary();
                    
                    // Update admin sections if admin
                    if (currentUser.position === 'Admin') {
                        updateAdminStats();
                        renderUserManagement();
                        renderReports();
                    }
                }
            }
        });
        
        // Enhanced periodic sync check with cross-network support (every 10 seconds)
        setInterval(function() {
            const lastUpdate = localStorage.getItem('motionlife_last_update');
            const lastSync = localStorage.getItem('motionlife_last_sync');
            const networkSync = JSON.parse(localStorage.getItem('motionlife_network_sync') || '{}');
            const now = Date.now();
            
            // Check for cross-network updates first
            if (networkSync.lastSync && networkSync.dataHash !== lastSyncHash) {
                console.log('Cross-network data change detected, syncing...');
                const hasNewData = loadFromCloud();
                if (hasNewData && currentUser) {
                    renderShiftSchedule();
                    renderAttendanceHistory();
                    updateCurrentStatus();
                    updatePersonalSummary();
                    
                    if (currentUser.position === 'Admin') {
                        updateAdminStats();
                        renderUserManagement();
                        renderReports();
                    }
                }
            }
            
            // Check if there's new local data from other devices on same network
            if (lastUpdate && (!lastSync || parseInt(lastUpdate) > parseInt(lastSync))) {
                console.log('Local network data change detected, syncing...');
                loadSyncedData();
                localStorage.setItem('motionlife_last_sync', now.toString());
                
                if (currentUser) {
                    renderShiftSchedule();
                    renderAttendanceHistory();
                    updateCurrentStatus();
                    updatePersonalSummary();
                    
                    // Update admin sections if admin
                    if (currentUser.position === 'Admin') {
                        updateAdminStats();
                        renderUserManagement();
                        renderReports();
                    }
                }
            }
            
            // Regular comprehensive sync check every 30 seconds
            if (!lastSync || (now - parseInt(lastSync)) > 30000) {
                console.log('Performing regular comprehensive sync...');
                loadSyncedData();
                localStorage.setItem('motionlife_last_sync', now.toString());
            }
        }, 10000);
        
        // Force sync when page becomes visible (mobile optimization)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Page became visible, forcing sync...');
                loadSyncedData();
                if (currentUser) {
                    renderShiftSchedule();
                    renderAttendanceHistory();
                    updateCurrentStatus();
                    updatePersonalSummary();
                    
                    if (currentUser.position === 'Admin') {
                        updateAdminStats();
                        renderUserManagement();
                        renderReports();
                    }
                }
            }
        });
        
        // Shift definitions
        const shifts = [
            { id: 1, name: 'Shift 1', start: '06:00', end: '10:00', color: 'bg-blue-500' },
            { id: 2, name: 'Shift 2', start: '10:00', end: '14:00', color: 'bg-green-500' },
            { id: 3, name: 'Shift 3', start: '14:00', end: '18:00', color: 'bg-yellow-500' },
            { id: 4, name: 'Shift 4', start: '18:00', end: '22:00', color: 'bg-purple-500' },
            { id: 5, name: 'Shift 5', start: '22:00', end: '06:00', color: 'bg-red-500' }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load synced data first
            loadSyncedData();
            
            // Create default admin account if not exists
            createDefaultAdmin();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check if user is logged in
            const savedUser = localStorage.getItem('motionlife_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
            
            // Update time every second
            updateTime();
            setInterval(updateTime, 1000);
        });
        
        // Create default admin account
        function createDefaultAdmin() {
            const adminExists = users.find(u => u.username === 'joseph');
            if (!adminExists) {
                const defaultAdmin = {
                    id: 1,
                    name: 'Administrator',
                    username: 'joseph',
                    password: 'joseph123',
                    position: 'Admin',
                    createdAt: new Date().toISOString()
                };
                users.push(defaultAdmin);
                syncData();
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Auth form handlers
            document.getElementById('showRegister').addEventListener('click', showRegisterForm);
            document.getElementById('showLogin').addEventListener('click', showLoginForm);
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('registerFormElement').addEventListener('submit', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('fingerprintScanner').addEventListener('click', handleFingerprint);
            document.getElementById('changePasswordBtn').addEventListener('click', showChangePasswordModal);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('cancelPasswordChange').addEventListener('click', hideChangePasswordModal);
            document.getElementById('editPositionForm').addEventListener('submit', handleEditPosition);
            document.getElementById('cancelPositionEdit').addEventListener('click', hideEditPositionModal);
            document.getElementById('adminResetPasswordForm').addEventListener('submit', handleAdminPasswordReset);
            document.getElementById('cancelAdminPasswordReset').addEventListener('click', hideAdminResetPasswordModal);
            
            
            // Manual sync button
            const manualSyncBtn = document.getElementById('manualSyncBtn');
            if (manualSyncBtn) {
                manualSyncBtn.addEventListener('click', handleManualSync);
            }
            
            // Admin navigation
            const navDashboard = document.getElementById('navDashboard');
            const navUsers = document.getElementById('navUsers');
            const navReports = document.getElementById('navReports');
            const navMyAttendance = document.getElementById('navMyAttendance');
            
            if (navDashboard) navDashboard.addEventListener('click', () => showAdminSection('dashboard'));
            if (navUsers) navUsers.addEventListener('click', () => showAdminSection('users'));
            if (navReports) navReports.addEventListener('click', () => showAdminSection('reports'));
            if (navMyAttendance) navMyAttendance.addEventListener('click', () => showAdminSection('attendance'));
            
            // Filter handlers
            const filterPeriod = document.getElementById('filterPeriod');
            const filterUser = document.getElementById('filterUser');
            const filterShift = document.getElementById('filterShift');
            const showWeeklySummary = document.getElementById('showWeeklySummary');
            const exportExcel = document.getElementById('exportExcel');
            const exportPDF = document.getElementById('exportPDF');
            
            if (filterPeriod) filterPeriod.addEventListener('change', renderReports);
            if (filterUser) filterUser.addEventListener('change', renderReports);
            if (filterShift) filterShift.addEventListener('change', renderReports);
            if (showWeeklySummary) showWeeklySummary.addEventListener('click', toggleWeeklySummary);
            if (exportExcel) exportExcel.addEventListener('click', exportToExcel);
            if (exportPDF) exportPDF.addEventListener('click', exportToPDF);
            
            // Personal data handlers
            const personalPeriodFilter = document.getElementById('personalPeriodFilter');
            const exportPersonalData = document.getElementById('exportPersonalData');
            
            if (personalPeriodFilter) personalPeriodFilter.addEventListener('change', updatePersonalSummary);
            if (exportPersonalData) exportPersonalData.addEventListener('click', exportPersonalDutyHours);
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('motionlife_current_user', JSON.stringify(user));
                showDashboard();
            } else {
                alert('Username atau password salah!');
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const position = document.getElementById('registerPosition').value;

            // Check if username already exists
            if (users.find(u => u.username === username)) {
                alert('Username sudah digunakan!');
                return;
            }

            const newUser = {
                id: Date.now(),
                name,
                username,
                password,
                position,
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            syncData(); // Sync across devices
            
            alert('Registrasi berhasil! Silakan login.');
            showLoginForm();
            
            // Clear form
            document.getElementById('registerFormElement').reset();
        }

        function handleLogout() {
            localStorage.removeItem('motionlife_current_user');
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
        }
        
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
        }
        
        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        }
        
        function handleChangePassword(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate old password
            if (oldPassword !== currentUser.password) {
                alert('Password lama tidak benar!');
                return;
            }
            
            // Validate new password
            if (newPassword.length < 6) {
                alert('Password baru minimal 6 karakter!');
                return;
            }
            
            // Validate password confirmation
            if (newPassword !== confirmPassword) {
                alert('Konfirmasi password tidak cocok!');
                return;
            }
            
            // Update password
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                currentUser.password = newPassword;
                
                // Update localStorage
                localStorage.setItem('motionlife_current_user', JSON.stringify(currentUser));
                syncData();
                
                alert('Password berhasil diubah!');
                hideChangePasswordModal();
            } else {
                alert('Terjadi kesalahan saat mengubah password!');
            }
        }
        
        function handleManualSync() {
            const btn = document.getElementById('manualSyncBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = 'üîÑ Menyinkron...';
            btn.disabled = true;
            updateSyncStatus('syncing');
            
            // Force comprehensive sync (local + cross-network)
            performEnhancedSync();
            loadSyncedData();
            
            // Update UI
            if (currentUser) {
                renderShiftSchedule();
                renderAttendanceHistory();
                updateCurrentStatus();
                updatePersonalSummary();
                
                if (currentUser.position === 'Admin') {
                    updateAdminStats();
                    renderUserManagement();
                    renderReports();
                }
            }
            
            setTimeout(() => {
                btn.innerHTML = '‚úÖ Tersinkron Semua Jaringan!';
                updateSyncStatus('success');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }, 1500);
        }

        function showDashboard() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update user info
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('userPositionDisplay').textContent = currentUser.position;
            
            // Check if user is admin
            if (currentUser.position === 'Admin') {
                document.getElementById('adminNav').classList.remove('hidden');
                showAdminSection('dashboard');
            } else {
                document.getElementById('adminNav').classList.add('hidden');
                showAdminSection('attendance');
            }
            
            // Initialize dashboard
            updateCurrentShift();
            renderShiftSchedule();
            renderAttendanceHistory();
            updateCurrentStatus();
            updatePersonalSummary();
        }
        
        function showAdminSection(section) {
            // Hide all sections
            document.getElementById('adminStats').classList.add('hidden');
            document.getElementById('userManagement').classList.add('hidden');
            document.getElementById('reportsSection').classList.add('hidden');
            document.getElementById('timeDisplay').classList.add('hidden');
            
            // Hide regular user sections
            const regularSections = ['quickActions', 'shiftSchedule', 'attendanceHistorySection'];
            regularSections.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
            
            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = 'nav-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200';
            });
            
            // Show selected section and update nav
            switch(section) {
                case 'dashboard':
                    document.getElementById('adminStats').classList.remove('hidden');
                    document.getElementById('timeDisplay').classList.remove('hidden');
                    document.getElementById('navDashboard').className = 'nav-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200';
                    updateAdminStats();
                    break;
                case 'users':
                    document.getElementById('userManagement').classList.remove('hidden');
                    document.getElementById('navUsers').className = 'nav-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200';
                    renderUserManagement();
                    break;
                case 'reports':
                    document.getElementById('reportsSection').classList.remove('hidden');
                    document.getElementById('navReports').className = 'nav-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200';
                    renderReports();
                    populateUserFilter();
                    break;
                case 'attendance':
                    // Show regular attendance sections
                    const quickActions = document.getElementById('quickActions');
                    const shiftSchedule = document.getElementById('shiftSchedule');
                    const attendanceHistorySection = document.getElementById('attendanceHistorySection');
                    
                    if (quickActions) quickActions.classList.remove('hidden');
                    if (shiftSchedule) shiftSchedule.classList.remove('hidden');
                    if (attendanceHistorySection) attendanceHistorySection.classList.remove('hidden');
                    
                    document.getElementById('timeDisplay').classList.remove('hidden');
                    
                    if (currentUser.position === 'Admin') {
                        document.getElementById('navMyAttendance').className = 'nav-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200';
                    }
                    break;
            }
        }
        
        function updateAdminStats() {
            // Total users
            document.getElementById('totalUsers').textContent = users.length;
            
            // Today's attendance
            const today = new Date().toDateString();
            const todayAttendance = attendanceData.filter(a => 
                new Date(a.date).toDateString() === today && a.clockIn
            ).length;
            document.getElementById('todayAttendance').textContent = todayAttendance;
            
            // Active shifts (users currently clocked in)
            const activeShifts = attendanceData.filter(a => 
                new Date(a.date).toDateString() === today && a.clockIn && !a.clockOut
            ).length;
            document.getElementById('activeShifts').textContent = activeShifts;
            
            // Total attendance records
            document.getElementById('totalAttendance').textContent = attendanceData.length;
        }
        
        function renderUserManagement() {
            const tbody = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            tbody.innerHTML = '';
            userCount.textContent = users.length;
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-4 text-center text-blue-200">
                            Belum ada user terdaftar
                        </td>
                    </tr>
                `;
                return;
            }
            
            users.forEach(user => {
                const createdDate = new Date(user.createdAt).toLocaleDateString('id-ID');
                const today = new Date().toDateString();
                const hasAttendanceToday = attendanceData.some(a => 
                    a.userId === user.id && 
                    new Date(a.date).toDateString() === today
                );
                
                const status = hasAttendanceToday ? 'Aktif' : 'Belum Absen';
                const statusClass = hasAttendanceToday ? 'text-green-400' : 'text-gray-400';
                
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10';
                row.innerHTML = `
                    <td class="py-3 text-white">${user.name}</td>
                    <td class="py-3 text-white">${user.username}</td>
                    <td class="py-3 text-white">${user.position}</td>
                    <td class="py-3 text-white">${createdDate}</td>
                    <td class="py-3 ${statusClass} font-semibold">${status}</td>
                    <td class="py-3">
                        <button onclick="viewUserDetails(${user.id})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded transition duration-200">
                            Detail
                        </button>
                        <button onclick="editUserPosition(${user.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded ml-2 transition duration-200">
                            Edit Posisi
                        </button>
                        <button onclick="adminResetUserPassword(${user.id})" class="bg-orange-500 hover:bg-orange-600 text-white text-xs px-3 py-1 rounded ml-2 transition duration-200">
                            Reset Password
                        </button>
                        ${user.position !== 'Admin' ? `
                        <button onclick="deleteUser(${user.id})" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded ml-2 transition duration-200">
                            Hapus
                        </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateUserFilter() {
            const filterUser = document.getElementById('filterUser');
            filterUser.innerHTML = '<option value="" style="background-color: #1e293b; color: white;">Semua User</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.position})`;
                option.style.backgroundColor = '#1e293b';
                option.style.color = 'white';
                filterUser.appendChild(option);
            });
        }
        
        function editUserPosition(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserPosition').value = user.position;
            document.getElementById('editPositionModal').classList.remove('hidden');
            
            // Store user ID for form submission
            document.getElementById('editPositionForm').dataset.userId = userId;
        }
        
        function hideEditPositionModal() {
            document.getElementById('editPositionModal').classList.add('hidden');
            document.getElementById('editPositionForm').reset();
        }
        
        function handleEditPosition(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('editPositionForm').dataset.userId);
            const newPosition = document.getElementById('editUserPosition').value;
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                const oldPosition = users[userIndex].position;
                users[userIndex].position = newPosition;
                
                // Update current user if editing own position
                if (currentUser && currentUser.id === userId) {
                    currentUser.position = newPosition;
                    localStorage.setItem('motionlife_current_user', JSON.stringify(currentUser));
                    document.getElementById('userPositionDisplay').textContent = newPosition;
                }
                
                syncData();
                renderUserManagement();
                hideEditPositionModal();
                
                alert(`Posisi user berhasil diubah dari "${oldPosition}" ke "${newPosition}"`);
            } else {
                alert('Terjadi kesalahan saat mengubah posisi user!');
            }
        }
        
        function getFilteredData() {
            const filterPeriod = document.getElementById('filterPeriod').value;
            const filterUserId = document.getElementById('filterUser').value;
            const filterShiftId = document.getElementById('filterShift').value;
            
            let filteredData = attendanceData;
            
            // Filter by period
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(filterPeriod) {
                case 'today':
                    filteredData = filteredData.filter(a => {
                        const attendanceDate = new Date(a.date);
                        return attendanceDate >= today;
                    });
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    filteredData = filteredData.filter(a => {
                        const attendanceDate = new Date(a.date);
                        return attendanceDate >= weekStart;
                    });
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    filteredData = filteredData.filter(a => {
                        const attendanceDate = new Date(a.date);
                        return attendanceDate >= monthStart;
                    });
                    break;
                // 'all' doesn't filter by date
            }
            
            if (filterUserId) {
                filteredData = filteredData.filter(a => a.userId == filterUserId);
            }
            
            if (filterShiftId) {
                filteredData = filteredData.filter(a => a.shiftId == filterShiftId);
            }
            
            return filteredData;
        }
        
        function renderReports() {
            const tbody = document.getElementById('reportsList');
            tbody.innerHTML = '';
            
            // Get filtered data
            const filteredData = getFilteredData();
            
            // Sort by date (newest first)
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-4 text-center text-blue-200">
                            Tidak ada data absensi
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredData.slice(0, 50).forEach(attendance => {
                const user = users.find(u => u.id === attendance.userId);
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                const clockIn = attendance.clockIn ? new Date(attendance.clockIn).toLocaleTimeString('id-ID') : '-';
                const clockOut = attendance.clockOut ? new Date(attendance.clockOut).toLocaleTimeString('id-ID') : '-';
                const status = attendance.clockOut ? 'Selesai' : 'Aktif';
                const statusClass = attendance.clockOut ? 'text-green-400' : 'text-yellow-400';
                
                // Calculate work duration
                let duration = '-';
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${diffHours}j ${diffMinutes}m`;
                }
                
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10';
                row.innerHTML = `
                    <td class="py-3 text-white">${user ? user.name : 'Unknown'}</td>
                    <td class="py-3 text-white">${user ? user.position : '-'}</td>
                    <td class="py-3 text-white">${date}</td>
                    <td class="py-3 text-white">${attendance.shiftName}</td>
                    <td class="py-3 text-white">${clockIn}</td>
                    <td class="py-3 text-white">${clockOut}</td>
                    <td class="py-3 text-blue-200 font-semibold">${duration}</td>
                    <td class="py-3 ${statusClass} font-semibold">${status}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function viewUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const userAttendance = attendanceData.filter(a => a.userId === userId);
            const totalAttendance = userAttendance.length;
            const completedShifts = userAttendance.filter(a => a.clockOut).length;
            
            alert(`Detail User: ${user.name}
            
Username: ${user.username}
Posisi: ${user.position}
Tanggal Daftar: ${new Date(user.createdAt).toLocaleDateString('id-ID')}

Statistik Absensi:
- Total Absensi: ${totalAttendance}
- Shift Selesai: ${completedShifts}
- Shift Aktif: ${totalAttendance - completedShifts}`);
        }
        
        function adminResetUserPassword(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('resetUserName').value = `${user.name} (${user.username})`;
            document.getElementById('adminResetPasswordModal').classList.remove('hidden');
            
            // Store user ID for form submission
            document.getElementById('adminResetPasswordForm').dataset.userId = userId;
        }
        
        function hideAdminResetPasswordModal() {
            document.getElementById('adminResetPasswordModal').classList.add('hidden');
            document.getElementById('adminResetPasswordForm').reset();
        }
        
        function handleAdminPasswordReset(e) {
            e.preventDefault();
            const userId = parseInt(document.getElementById('adminResetPasswordForm').dataset.userId);
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            
            // Validate password
            if (newPassword.length < 6) {
                alert('Password baru minimal 6 karakter!');
                return;
            }
            
            // Validate password confirmation
            if (newPassword !== confirmPassword) {
                alert('Konfirmasi password tidak cocok!');
                return;
            }
            
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                const userName = users[userIndex].name;
                users[userIndex].password = newPassword;
                
                syncData();
                hideAdminResetPasswordModal();
                
                alert(`‚úÖ Password user "${userName}" berhasil direset!\n\nPassword baru: ${newPassword}\n\nUser harus login ulang dengan password baru.`);
            } else {
                alert('Terjadi kesalahan saat mereset password!');
            }
        }
        
        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`Apakah Anda yakin ingin menghapus user "${user.name}"?\n\nSemua data absensi user ini juga akan dihapus.`)) {
                // Remove user
                users = users.filter(u => u.id !== userId);
                
                // Remove user's attendance data
                attendanceData = attendanceData.filter(a => a.userId !== userId);
                
                // Sync data
                syncData();
                
                // Refresh display
                renderUserManagement();
                updateAdminStats();
                
                alert('User berhasil dihapus!');
            }
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const dateString = now.toLocaleDateString('id-ID', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
            
            // Update current shift
            updateCurrentShift();
        }

        function updateCurrentShift() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            // Find the most appropriate shift based on current time
            for (let shift of shifts) {
                const [startHour, startMin] = shift.start.split(':').map(Number);
                const [endHour, endMin] = shift.end.split(':').map(Number);
                
                let startTime = startHour * 60 + startMin;
                let endTime = endHour * 60 + endMin;
                
                // Handle overnight shifts (like Shift 5: 22:00-06:00)
                if (endTime < startTime) {
                    if (currentTime >= startTime || currentTime < endTime) {
                        currentShift = shift;
                        return;
                    }
                } else {
                    if (currentTime >= startTime && currentTime < endTime) {
                        currentShift = shift;
                        return;
                    }
                }
            }
            
            // If no exact match, find the nearest upcoming shift (24/7 availability)
            let nearestShift = shifts[0];
            let minDistance = Infinity;
            
            for (let shift of shifts) {
                const [startHour, startMin] = shift.start.split(':').map(Number);
                let startTime = startHour * 60 + startMin;
                
                let distance;
                if (startTime > currentTime) {
                    distance = startTime - currentTime;
                } else {
                    distance = (24 * 60) - currentTime + startTime; // Next day
                }
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestShift = shift;
                }
            }
            
            currentShift = nearestShift; // Always have an active shift for 24/7 operation
        }

        function renderShiftSchedule() {
            const container = document.getElementById('shiftScheduleGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            const today = new Date().toDateString();
            
            shifts.forEach(shift => {
                // Get all attendance records for this shift today
                const shiftAttendances = attendanceData.filter(a => 
                    a.userId === currentUser.id && 
                    new Date(a.date).toDateString() === today && 
                    a.shiftId === shift.id
                );
                
                // Check if there's an active (not clocked out) attendance
                const activeAttendance = shiftAttendances.find(a => a.clockIn && !a.clockOut);
                const completedAttendances = shiftAttendances.filter(a => a.clockOut);
                
                let status = 'pending';
                let statusText = 'Belum Absen';
                let statusClass = 'shift-pending';
                
                if (activeAttendance) {
                    status = 'active';
                    const sessionText = activeAttendance.sessionNumber > 1 ? ` (Sesi ${activeAttendance.sessionNumber})` : '';
                    statusText = `Sedang Aktif${sessionText}`;
                    statusClass = 'shift-active';
                } else if (completedAttendances.length > 0) {
                    status = 'completed';
                    const sessionText = completedAttendances.length > 1 ? ` (${completedAttendances.length} Sesi)` : '';
                    statusText = `Selesai${sessionText}`;
                    statusClass = 'shift-completed';
                }
                
                const shiftCard = document.createElement('div');
                shiftCard.className = `shift-card ${statusClass} rounded-xl p-4 text-white text-center`;
                shiftCard.innerHTML = `
                    <h3 class="font-bold text-lg mb-2">${shift.name}</h3>
                    <p class="text-sm opacity-90 mb-2">${shift.start} - ${shift.end}</p>
                    <div class="text-xs font-semibold">${statusText}</div>
                `;
                
                container.appendChild(shiftCard);
            });
        }

        function handleFingerprint() {
            const scanner = document.getElementById('fingerprintScanner');
            const scanLine = document.getElementById('scanLine');
            
            // Show scanning animation
            scanLine.classList.remove('hidden');
            scanLine.classList.add('scan-animation');
            
            setTimeout(() => {
                scanLine.classList.add('hidden');
                scanLine.classList.remove('scan-animation');
                
                if (!currentShift) {
                    alert('Tidak ada shift aktif saat ini!');
                    return;
                }
                
                processAttendance();
            }, 3000);
        }

        function processAttendance() {
            const today = new Date().toDateString();
            const now = new Date();
            
            // Find all attendance records for today and current shift
            const todayAttendances = attendanceData.filter(a => 
                a.userId === currentUser.id && 
                new Date(a.date).toDateString() === today && 
                a.shiftId === currentShift.id
            );
            
            // Find the most recent active attendance (not clocked out)
            let activeAttendance = todayAttendances.find(a => a.clockIn && !a.clockOut);
            
            if (!activeAttendance) {
                // No active attendance - Create new clock in
                const newAttendance = {
                    id: Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    shiftId: currentShift.id,
                    shiftName: currentShift.name,
                    date: now.toISOString(),
                    clockIn: now.toISOString(),
                    clockOut: null,
                    entries: [{ type: 'in', time: now.toISOString() }],
                    sessionNumber: todayAttendances.length + 1
                };
                attendanceData.push(newAttendance);
                
                const sessionText = todayAttendances.length > 0 ? ` (Sesi ${newAttendance.sessionNumber})` : '';
                alert(`‚úÖ Clock IN berhasil!\n${currentShift.name}${sessionText}\n${now.toLocaleTimeString('id-ID')}`);
            } else {
                // There's an active attendance - Clock out
                activeAttendance.clockOut = now.toISOString();
                if (!activeAttendance.entries) activeAttendance.entries = [];
                activeAttendance.entries.push({ type: 'out', time: now.toISOString() });
                
                // Calculate work duration
                const start = new Date(activeAttendance.clockIn);
                const end = new Date(activeAttendance.clockOut);
                const diffMs = end - start;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                const sessionText = activeAttendance.sessionNumber > 1 ? ` (Sesi ${activeAttendance.sessionNumber})` : '';
                alert(`‚úÖ Clock OUT berhasil!\n${currentShift.name}${sessionText}\n${now.toLocaleTimeString('id-ID')}\nDurasi kerja: ${diffHours}j ${diffMinutes}m`);
            }
            
            syncData(); // Sync across devices
            renderShiftSchedule();
            renderAttendanceHistory();
            updateCurrentStatus();
            updatePersonalSummary();
        }

        function updateCurrentStatus() {
            const today = new Date().toDateString();
            const activeAttendance = attendanceData.find(a => 
                a.userId === currentUser.id && 
                new Date(a.date).toDateString() === today && 
                a.clockIn && !a.clockOut
            );
            
            const statusIndicator = document.getElementById('statusIndicator');
            const statusDot = document.getElementById('statusDot');
            const currentStatus = document.getElementById('currentStatus');
            const statusTime = document.getElementById('statusTime');
            
            if (activeAttendance) {
                statusIndicator.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-green-500';
                statusDot.className = 'w-4 h-4 rounded-full status-indicator bg-green-300';
                
                const sessionText = activeAttendance.sessionNumber > 1 ? ` (Sesi ${activeAttendance.sessionNumber})` : '';
                currentStatus.textContent = `Aktif - ${activeAttendance.shiftName}${sessionText}`;
                statusTime.textContent = `Masuk: ${new Date(activeAttendance.clockIn).toLocaleTimeString('id-ID')}`;
            } else {
                statusIndicator.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-gray-500';
                statusDot.className = 'w-4 h-4 rounded-full status-indicator bg-gray-300';
                currentStatus.textContent = 'Belum Absen';
                statusTime.textContent = '-';
            }
        }

        function renderAttendanceHistory() {
            const tbody = document.getElementById('attendanceHistory');
            const historyCount = document.getElementById('historyCount');
            tbody.innerHTML = '';
            
            // Get user's attendance history (last 15 records)
            const userAttendance = attendanceData
                .filter(a => a.userId === currentUser.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 15);
            
            if (historyCount) historyCount.textContent = userAttendance.length;
            
            if (userAttendance.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="py-4 text-center text-blue-200">
                            Belum ada riwayat absensi
                        </td>
                    </tr>
                `;
                return;
            }
            
            userAttendance.forEach(attendance => {
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                const clockIn = attendance.clockIn ? new Date(attendance.clockIn).toLocaleTimeString('id-ID') : '-';
                const clockOut = attendance.clockOut ? new Date(attendance.clockOut).toLocaleTimeString('id-ID') : '-';
                const status = attendance.clockOut ? 'Selesai' : 'Aktif';
                const statusClass = attendance.clockOut ? 'text-green-400' : 'text-yellow-400';
                
                // Calculate work duration
                let duration = '-';
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${diffHours}j ${diffMinutes}m`;
                }
                
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10';
                row.innerHTML = `
                    <td class="py-3 text-white">${date}</td>
                    <td class="py-3 text-white">${attendance.shiftName}</td>
                    <td class="py-3 text-white">${clockIn}</td>
                    <td class="py-3 text-white">${clockOut}</td>
                    <td class="py-3 text-blue-200 font-semibold">${duration}</td>
                    <td class="py-3 ${statusClass} font-semibold">${status}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function exportToExcel() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            // Create CSV content
            let csvContent = 'Nama,Posisi,Tanggal,Shift,Jam Masuk,Jam Keluar,Status,Durasi Kerja\n';
            
            filteredData.forEach(attendance => {
                const user = users.find(u => u.id === attendance.userId);
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                const clockIn = attendance.clockIn ? new Date(attendance.clockIn).toLocaleTimeString('id-ID') : '-';
                const clockOut = attendance.clockOut ? new Date(attendance.clockOut).toLocaleTimeString('id-ID') : '-';
                const status = attendance.clockOut ? 'Selesai' : 'Aktif';
                
                // Calculate work duration
                let duration = '-';
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${diffHours}j ${diffMinutes}m`;
                }
                
                csvContent += `"${user ? user.name : 'Unknown'}","${user ? user.position : '-'}","${date}","${attendance.shiftName}","${clockIn}","${clockOut}","${status}","${duration}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const period = document.getElementById('filterPeriod').value;
            const periodName = {
                'today': 'Hari_Ini',
                'week': 'Minggu_Ini', 
                'month': 'Bulan_Ini',
                'all': 'Semua_Data'
            }[period];
            
            const filename = `Laporan_Absensi_${periodName}_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Data berhasil diekspor ke file: ${filename}`);
        }
        
        function exportToPDF() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            // Create HTML content for PDF
            const period = document.getElementById('filterPeriod').value;
            const periodName = {
                'today': 'Hari Ini',
                'week': 'Minggu Ini', 
                'month': 'Bulan Ini',
                'all': 'Semua Data'
            }[period];
            
            let htmlContent = `
                <html>
                <head>
                    <title>Laporan Absensi MotionLife Medical Center</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #1e40af; margin-bottom: 5px; }
                        .header p { color: #666; margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #1e40af; color: white; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .summary { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MOTIONLIFE MEDICAL CENTER</h1>
                        <p>Laporan Absensi - ${periodName}</p>
                        <p>Dicetak pada: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                    </div>
                    
                    <div class="summary">
                        <h3>Ringkasan:</h3>
                        <p>Total Record: ${filteredData.length}</p>
                        <p>Shift Selesai: ${filteredData.filter(a => a.clockOut).length}</p>
                        <p>Shift Aktif: ${filteredData.filter(a => !a.clockOut).length}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Posisi</th>
                                <th>Tanggal</th>
                                <th>Shift</th>
                                <th>Jam Masuk</th>
                                <th>Jam Keluar</th>
                                <th>Status</th>
                                <th>Durasi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredData.forEach((attendance, index) => {
                const user = users.find(u => u.id === attendance.userId);
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                const clockIn = attendance.clockIn ? new Date(attendance.clockIn).toLocaleTimeString('id-ID') : '-';
                const clockOut = attendance.clockOut ? new Date(attendance.clockOut).toLocaleTimeString('id-ID') : '-';
                const status = attendance.clockOut ? 'Selesai' : 'Aktif';
                
                // Calculate work duration
                let duration = '-';
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${diffHours}j ${diffMinutes}m`;
                }
                
                htmlContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${user ? user.name : 'Unknown'}</td>
                        <td>${user ? user.position : '-'}</td>
                        <td>${date}</td>
                        <td>${attendance.shiftName}</td>
                        <td>${clockIn}</td>
                        <td>${clockOut}</td>
                        <td>${status}</td>
                        <td>${duration}</td>
                    </tr>
                `;
            });
            
            htmlContent += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Laporan ini dibuat secara otomatis oleh Sistem Absensi MotionLife Medical Center</p>
                        <p>Dicetak oleh: ${currentUser.name} (${currentUser.position})</p>
                    </div>
                </body>
                </html>
            `;
            
            // Open in new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Auto print after content loads
            printWindow.onload = function() {
                printWindow.print();
            };
            
            alert('Laporan PDF telah dibuka di tab baru. Silakan print atau save as PDF.');
        }
        
        function toggleWeeklySummary() {
            const summarySection = document.getElementById('weeklySummarySection');
            const btn = document.getElementById('showWeeklySummary');
            
            if (summarySection.classList.contains('hidden')) {
                summarySection.classList.remove('hidden');
                btn.textContent = 'üìä Sembunyikan Rekap';
                btn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm';
                generateWeeklySummary();
            } else {
                summarySection.classList.add('hidden');
                btn.textContent = 'üìà Rekap Mingguan';
                btn.className = 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-200 text-sm';
            }
        }
        
        function generateWeeklySummary() {
            // Get current week's start and end dates
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay; // Adjust to get Monday
            
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() + mondayOffset);
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            // Display week period
            const weekPeriodText = `${weekStart.toLocaleDateString('id-ID')} - ${weekEnd.toLocaleDateString('id-ID')}`;
            document.getElementById('weekPeriod').textContent = weekPeriodText;
            
            // Filter attendance data for current week
            const weeklyData = attendanceData.filter(a => {
                const attendanceDate = new Date(a.date);
                return attendanceDate >= weekStart && attendanceDate <= weekEnd && a.clockOut;
            });
            
            // Calculate statistics
            let totalHours = 0;
            let totalSessions = 0;
            const userHours = {};
            const dailyHours = [0, 0, 0, 0, 0, 0, 0]; // Mon-Sun
            const shiftHours = {}; // Track hours per shift
            
            weeklyData.forEach(attendance => {
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const hours = (end - start) / (1000 * 60 * 60); // Convert to hours
                    
                    totalHours += hours;
                    totalSessions++;
                    
                    // Track shift hours
                    if (!shiftHours[attendance.shiftName]) {
                        shiftHours[attendance.shiftName] = 0;
                    }
                    shiftHours[attendance.shiftName] += hours;
                    
                    // Track per user
                    const user = users.find(u => u.id === attendance.userId);
                    if (user) {
                        if (!userHours[user.id]) {
                            userHours[user.id] = {
                                name: user.name,
                                position: user.position,
                                totalHours: 0,
                                sessions: 0,
                                dailyHours: [0, 0, 0, 0, 0, 0, 0]
                            };
                        }
                        userHours[user.id].totalHours += hours;
                        userHours[user.id].sessions++;
                        
                        // Track daily hours
                        const dayIndex = (start.getDay() + 6) % 7; // Convert to Mon=0, Tue=1, etc.
                        userHours[user.id].dailyHours[dayIndex] += hours;
                        dailyHours[dayIndex] += hours;
                    }
                }
            });
            
            // Update main summary cards
            document.getElementById('totalWeeklyHours').textContent = `${Math.round(totalHours * 10) / 10} jam`;
            document.getElementById('totalSessions').textContent = `${totalSessions} sesi kerja`;
            
            const activeUsers = Object.keys(userHours).length;
            const averageHours = activeUsers > 0 ? totalHours / activeUsers : 0;
            document.getElementById('averageWeeklyHours').textContent = `${Math.round(averageHours * 10) / 10} jam`;
            document.getElementById('activeUsersCount').textContent = `${activeUsers} user aktif`;
            
            // Find most active user
            let mostActiveUser = '-';
            let mostActiveUserDetail = '-';
            let maxHours = 0;
            Object.values(userHours).forEach(user => {
                if (user.totalHours > maxHours) {
                    maxHours = user.totalHours;
                    mostActiveUser = user.name;
                    mostActiveUserDetail = `${Math.round(user.totalHours * 10) / 10}j dalam ${user.sessions} sesi`;
                }
            });
            document.getElementById('mostActiveUser').textContent = mostActiveUser;
            document.getElementById('mostActiveUserDetails').textContent = mostActiveUserDetail;
            
            // Find most popular shift
            let popularShift = '-';
            let popularShiftHours = 0;
            let maxShiftHours = 0;
            Object.entries(shiftHours).forEach(([shiftName, hours]) => {
                if (hours > maxShiftHours) {
                    maxShiftHours = hours;
                    popularShift = shiftName;
                    popularShiftHours = hours;
                }
            });
            document.getElementById('popularShift').textContent = popularShift;
            document.getElementById('popularShiftHours').textContent = `${Math.round(popularShiftHours * 10) / 10} jam total`;
            
            // Update quick stats
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('workingUsers').textContent = activeUsers;
            document.getElementById('totalShifts').textContent = totalSessions;
            
            const avgDailyHours = totalHours / 7; // Average per day
            document.getElementById('avgDailyHours').textContent = `${Math.round(avgDailyHours * 10) / 10}j`;
            
            // Update chart total
            document.getElementById('chartTotal').textContent = `${Math.round(totalHours * 10) / 10} jam`;
            
            // Generate daily chart
            generateWeeklyChart(dailyHours);
            
            // Generate detailed table
            generateWeeklyDetailTable(userHours, weekStart, weekEnd);
        }
        
        function generateWeeklyChart(dailyHours) {
            const chartContainer = document.getElementById('weeklyChart');
            const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
            const maxHours = Math.max(...dailyHours, 1);
            
            chartContainer.innerHTML = '';
            
            dailyHours.forEach((hours, index) => {
                const percentage = (hours / maxHours) * 100;
                const barContainer = document.createElement('div');
                barContainer.className = 'flex items-center space-x-2 text-sm';
                barContainer.innerHTML = `
                    <div class="w-8 text-blue-200 font-semibold">${days[index]}</div>
                    <div class="flex-1 bg-white/10 rounded-full h-4 relative">
                        <div class="bg-blue-500 h-4 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                    <div class="w-12 text-white text-xs">${Math.round(hours)}j</div>
                `;
                chartContainer.appendChild(barContainer);
            });
        }
        
        function generateWeeklyDetailTable(userHours, weekStart, weekEnd) {
            const tbody = document.getElementById('weeklyDetailTable');
            tbody.innerHTML = '';
            
            if (Object.keys(userHours).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="py-4 text-center text-blue-200">
                            Belum ada data jam kerja minggu ini
                            <br><small class="text-xs text-blue-300">Periode: ${weekStart.toLocaleDateString('id-ID')} - ${weekEnd.toLocaleDateString('id-ID')}</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort users by total hours (descending)
            const sortedUsers = Object.values(userHours).sort((a, b) => b.totalHours - a.totalHours);
            
            // Add header with ranking
            let rank = 1;
            sortedUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                
                // Add ranking badge for top 3
                let rankBadge = '';
                if (rank === 1) rankBadge = 'ü•á';
                else if (rank === 2) rankBadge = 'ü•à';
                else if (rank === 3) rankBadge = 'ü•â';
                else rankBadge = `#${rank}`;
                
                const dailyCells = user.dailyHours.map((hours, dayIndex) => {
                    const dayName = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'][dayIndex];
                    const hoursText = hours > 0 ? Math.round(hours * 10) / 10 + 'j' : '-';
                    const cellClass = hours > 8 ? 'text-green-400 font-bold' : hours > 4 ? 'text-yellow-400' : 'text-white';
                    return `<td class="py-3 text-center ${cellClass}" title="${dayName}: ${hoursText}">${hoursText}</td>`;
                }).join('');
                
                // Calculate efficiency (hours per session)
                const efficiency = user.sessions > 0 ? user.totalHours / user.sessions : 0;
                const efficiencyText = efficiency > 0 ? `${Math.round(efficiency * 10) / 10}j/sesi` : '-';
                
                row.innerHTML = `
                    <td class="py-3 text-white">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${rankBadge}</span>
                            <div>
                                <div class="font-semibold">${user.name}</div>
                                <div class="text-xs text-blue-300">${user.sessions} sesi ‚Ä¢ ${efficiencyText}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 text-white">
                        <span class="px-2 py-1 bg-blue-500/20 rounded-full text-xs">${user.position}</span>
                    </td>
                    ${dailyCells}
                    <td class="py-3 text-center">
                        <div class="text-blue-200 font-bold text-lg">${Math.round(user.totalHours * 10) / 10}j</div>
                        <div class="text-xs text-blue-300">${user.sessions} sesi</div>
                    </td>
                `;
                tbody.appendChild(row);
                rank++;
            });
            
            // Add summary statistics row
            const statsRow = document.createElement('tr');
            statsRow.className = 'border-t-2 border-blue-500/50 bg-blue-500/10';
            
            const totalDailyCells = [0, 1, 2, 3, 4, 5, 6].map(dayIndex => {
                const dayTotal = sortedUsers.reduce((sum, user) => sum + user.dailyHours[dayIndex], 0);
                const dayName = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'][dayIndex];
                const hoursText = dayTotal > 0 ? Math.round(dayTotal * 10) / 10 + 'j' : '-';
                return `<td class="py-3 text-center text-blue-200 font-semibold" title="${dayName}: ${hoursText}">${hoursText}</td>`;
            }).join('');
            
            const grandTotal = sortedUsers.reduce((sum, user) => sum + user.totalHours, 0);
            const totalSessions = sortedUsers.reduce((sum, user) => sum + user.sessions, 0);
            const avgEfficiency = totalSessions > 0 ? grandTotal / totalSessions : 0;
            
            statsRow.innerHTML = `
                <td class="py-3 text-blue-200">
                    <div class="font-bold">üìä TOTAL SEMUA USER</div>
                    <div class="text-xs text-blue-300">${totalSessions} total sesi ‚Ä¢ ${Math.round(avgEfficiency * 10) / 10}j rata-rata/sesi</div>
                </td>
                <td class="py-3 text-center text-blue-300 text-xs">
                    ${sortedUsers.length} user<br>bekerja
                </td>
                ${totalDailyCells}
                <td class="py-3 text-center">
                    <div class="text-blue-200 font-bold text-xl">${Math.round(grandTotal * 10) / 10}j</div>
                    <div class="text-xs text-blue-300">${totalSessions} sesi</div>
                </td>
            `;
            tbody.appendChild(statsRow);
            
            // Add average row
            const avgRow = document.createElement('tr');
            avgRow.className = 'border-t border-blue-500/30 bg-green-500/10';
            
            const avgDailyCells = [0, 1, 2, 3, 4, 5, 6].map(dayIndex => {
                const dayTotal = sortedUsers.reduce((sum, user) => sum + user.dailyHours[dayIndex], 0);
                const dayAvg = sortedUsers.length > 0 ? dayTotal / sortedUsers.length : 0;
                const avgText = dayAvg > 0 ? Math.round(dayAvg * 10) / 10 + 'j' : '-';
                return `<td class="py-3 text-center text-green-200 font-semibold">${avgText}</td>`;
            }).join('');
            
            const avgTotal = sortedUsers.length > 0 ? grandTotal / sortedUsers.length : 0;
            const avgSessions = sortedUsers.length > 0 ? totalSessions / sortedUsers.length : 0;
            
            avgRow.innerHTML = `
                <td class="py-3 text-green-200">
                    <div class="font-bold">üìà RATA-RATA PER USER</div>
                    <div class="text-xs text-green-300">${Math.round(avgSessions * 10) / 10} sesi rata-rata</div>
                </td>
                <td class="py-3 text-center text-green-300 text-xs">
                    per user
                </td>
                ${avgDailyCells}
                <td class="py-3 text-center">
                    <div class="text-green-200 font-bold text-lg">${Math.round(avgTotal * 10) / 10}j</div>
                    <div class="text-xs text-green-300">rata-rata</div>
                </td>
            `;
            tbody.appendChild(avgRow);
        }
        
        function updatePersonalSummary() {
            if (!currentUser) return;
            
            const period = document.getElementById('personalPeriodFilter').value;
            const now = new Date();
            let startDate = new Date();
            let periodText = '';
            
            // Set date range based on selected period
            switch(period) {
                case 'week':
                    const currentDay = now.getDay();
                    const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
                    startDate.setDate(now.getDate() + mondayOffset);
                    startDate.setHours(0, 0, 0, 0);
                    periodText = 'Minggu ini';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    periodText = 'Bulan ini';
                    break;
                case 'all':
                    startDate = new Date(0); // Beginning of time
                    periodText = 'Semua waktu';
                    break;
            }
            
            // Filter user's attendance data
            const personalData = attendanceData.filter(a => {
                return a.userId === currentUser.id && 
                       new Date(a.date) >= startDate && 
                       a.clockOut; // Only completed sessions
            });
            
            // Calculate statistics
            let totalHours = 0;
            let totalSessions = personalData.length;
            let completedSessions = personalData.filter(a => a.clockOut).length;
            const shiftHours = {};
            const last7Days = [];
            
            // Get last 7 days for chart
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                last7Days.push({
                    date: date,
                    hours: 0,
                    dayName: date.toLocaleDateString('id-ID', { weekday: 'short' })
                });
            }
            
            personalData.forEach(attendance => {
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const hours = (end - start) / (1000 * 60 * 60);
                    
                    totalHours += hours;
                    
                    // Track shift hours
                    if (!shiftHours[attendance.shiftName]) {
                        shiftHours[attendance.shiftName] = { hours: 0, sessions: 0 };
                    }
                    shiftHours[attendance.shiftName].hours += hours;
                    shiftHours[attendance.shiftName].sessions++;
                    
                    // Track daily hours for chart (last 7 days only)
                    const attendanceDate = new Date(attendance.date);
                    attendanceDate.setHours(0, 0, 0, 0);
                    
                    const dayIndex = last7Days.findIndex(day => 
                        day.date.getTime() === attendanceDate.getTime()
                    );
                    if (dayIndex !== -1) {
                        last7Days[dayIndex].hours += hours;
                    }
                }
            });
            
            // Update main stats
            document.getElementById('personalTotalHours').textContent = `${Math.round(totalHours * 10) / 10}j`;
            document.getElementById('personalPeriodText').textContent = periodText;
            document.getElementById('personalTotalSessions').textContent = totalSessions;
            document.getElementById('personalCompletedSessions').textContent = `${completedSessions} selesai`;
            
            // Calculate averages
            const daysInPeriod = period === 'week' ? 7 : period === 'month' ? 30 : Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24)));
            const avgHoursPerDay = totalHours / daysInPeriod;
            const efficiency = totalSessions > 0 ? totalHours / totalSessions : 0;
            
            document.getElementById('personalAvgHours').textContent = `${Math.round(avgHoursPerDay * 10) / 10}j`;
            document.getElementById('personalEfficiency').textContent = `${Math.round(efficiency * 10) / 10}j/sesi`;
            
            // Find favorite shift
            let favoriteShift = '-';
            let favoriteShiftHours = 0;
            let maxHours = 0;
            
            Object.entries(shiftHours).forEach(([shiftName, data]) => {
                if (data.hours > maxHours) {
                    maxHours = data.hours;
                    favoriteShift = shiftName;
                    favoriteShiftHours = data.hours;
                }
            });
            
            document.getElementById('personalFavoriteShift').textContent = favoriteShift;
            document.getElementById('personalFavoriteShiftHours').textContent = favoriteShift !== '-' ? `${Math.round(favoriteShiftHours * 10) / 10}j` : '0j';
            
            // Generate charts
            generatePersonalWeeklyChart(last7Days);
            generatePersonalShiftBreakdown(shiftHours);
        }
        
        function generatePersonalWeeklyChart(dailyData) {
            const chartContainer = document.getElementById('personalWeeklyChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            const maxHours = Math.max(...dailyData.map(d => d.hours), 1);
            
            dailyData.forEach(day => {
                const percentage = (day.hours / maxHours) * 100;
                const barContainer = document.createElement('div');
                barContainer.className = 'flex items-center space-x-2 text-sm';
                barContainer.innerHTML = `
                    <div class="w-8 text-blue-200 font-semibold">${day.dayName}</div>
                    <div class="flex-1 bg-white/10 rounded-full h-4 relative">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-4 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                    <div class="w-12 text-white text-xs">${day.hours > 0 ? Math.round(day.hours * 10) / 10 + 'j' : '-'}</div>
                `;
                chartContainer.appendChild(barContainer);
            });
        }
        
        function generatePersonalShiftBreakdown(shiftHours) {
            const container = document.getElementById('personalShiftBreakdown');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Show all shifts, even if no hours
            shifts.forEach(shift => {
                const data = shiftHours[shift.name] || { hours: 0, sessions: 0 };
                const hours = Math.round(data.hours * 10) / 10;
                const sessions = data.sessions;
                
                const shiftCard = document.createElement('div');
                shiftCard.className = `${shift.color}/20 rounded-lg p-3 text-center border border-white/10`;
                shiftCard.innerHTML = `
                    <div class="text-lg font-bold text-white">${shift.name}</div>
                    <div class="text-sm text-blue-200 mb-1">${shift.start} - ${shift.end}</div>
                    <div class="text-xl font-bold text-white">${hours}j</div>
                    <div class="text-xs text-blue-300">${sessions} sesi</div>
                `;
                container.appendChild(shiftCard);
            });
        }
        
        function exportPersonalDutyHours() {
            if (!currentUser) return;
            
            const period = document.getElementById('personalPeriodFilter').value;
            const now = new Date();
            let startDate = new Date();
            let periodName = '';
            
            // Set date range based on selected period
            switch(period) {
                case 'week':
                    const currentDay = now.getDay();
                    const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
                    startDate.setDate(now.getDate() + mondayOffset);
                    startDate.setHours(0, 0, 0, 0);
                    periodName = 'Minggu_Ini';
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    periodName = 'Bulan_Ini';
                    break;
                case 'all':
                    startDate = new Date(0);
                    periodName = 'Semua_Data';
                    break;
            }
            
            // Filter user's data
            const personalData = attendanceData.filter(a => {
                return a.userId === currentUser.id && new Date(a.date) >= startDate;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (personalData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            // Calculate summary statistics
            let totalHours = 0;
            let completedSessions = 0;
            const shiftStats = {};
            
            personalData.forEach(attendance => {
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const hours = (end - start) / (1000 * 60 * 60);
                    totalHours += hours;
                    completedSessions++;
                    
                    if (!shiftStats[attendance.shiftName]) {
                        shiftStats[attendance.shiftName] = { hours: 0, sessions: 0 };
                    }
                    shiftStats[attendance.shiftName].hours += hours;
                    shiftStats[attendance.shiftName].sessions++;
                }
            });
            
            // Create CSV content
            let csvContent = `LAPORAN JAM KERJA PERSONAL - ${currentUser.name}\n`;
            csvContent += `Posisi: ${currentUser.position}\n`;
            csvContent += `Periode: ${period === 'week' ? 'Minggu Ini' : period === 'month' ? 'Bulan Ini' : 'Semua Data'}\n`;
            csvContent += `Tanggal Export: ${now.toLocaleDateString('id-ID')} ${now.toLocaleTimeString('id-ID')}\n\n`;
            
            // Summary statistics
            csvContent += `RINGKASAN:\n`;
            csvContent += `Total Jam Kerja,${Math.round(totalHours * 10) / 10} jam\n`;
            csvContent += `Total Sesi,${personalData.length}\n`;
            csvContent += `Sesi Selesai,${completedSessions}\n`;
            csvContent += `Rata-rata per Sesi,${completedSessions > 0 ? Math.round((totalHours / completedSessions) * 10) / 10 : 0} jam\n\n`;
            
            // Shift breakdown
            csvContent += `BREAKDOWN PER SHIFT:\n`;
            csvContent += `Shift,Total Jam,Jumlah Sesi,Rata-rata per Sesi\n`;
            Object.entries(shiftStats).forEach(([shiftName, stats]) => {
                const avgPerSession = stats.sessions > 0 ? stats.hours / stats.sessions : 0;
                csvContent += `"${shiftName}",${Math.round(stats.hours * 10) / 10},${stats.sessions},${Math.round(avgPerSession * 10) / 10}\n`;
            });
            
            csvContent += `\nDETAIL ABSENSI:\n`;
            csvContent += `Tanggal,Shift,Jam Masuk,Jam Keluar,Durasi,Status\n`;
            
            personalData.forEach(attendance => {
                const date = new Date(attendance.date).toLocaleDateString('id-ID');
                const clockIn = attendance.clockIn ? new Date(attendance.clockIn).toLocaleTimeString('id-ID') : '-';
                const clockOut = attendance.clockOut ? new Date(attendance.clockOut).toLocaleTimeString('id-ID') : '-';
                const status = attendance.clockOut ? 'Selesai' : 'Aktif';
                
                let duration = '-';
                if (attendance.clockIn && attendance.clockOut) {
                    const start = new Date(attendance.clockIn);
                    const end = new Date(attendance.clockOut);
                    const diffMs = end - start;
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${diffHours}j ${diffMinutes}m`;
                }
                
                csvContent += `"${date}","${attendance.shiftName}","${clockIn}","${clockOut}","${duration}","${status}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            const filename = `Jam_Kerja_${currentUser.name.replace(/\s+/g, '_')}_${periodName}_${now.toISOString().split('T')[0]}.csv`;
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Data jam kerja berhasil diekspor!\n\nFile: ${filename}\n\nRingkasan:\n‚Ä¢ Total: ${Math.round(totalHours * 10) / 10} jam\n‚Ä¢ Sesi: ${personalData.length}\n‚Ä¢ Periode: ${period === 'week' ? 'Minggu Ini' : period === 'month' ? 'Bulan Ini' : 'Semua Data'}`);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96efcc0af7a83f6c',t:'MTc1NTE2NzYzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
